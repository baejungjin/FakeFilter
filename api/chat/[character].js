const OpenAI = require('openai');

// ================================
// π­ μΊλ¦­ν„°λ³„ AI ν”„λ΅¬ν”„νΈ μ„¤μ • β¨
// ================================

const CHARACTER_PROMPTS = {
    // πΈ λ―Όμ§€ (μ΄κΈ‰) - λ°±μ‹  λ¶€μ‘μ© κ°€μ§λ‰΄μ¤μ— ν„νΉλ μΊλ¦­ν„°
    minji: {
        systemPrompt: `λ‹Ήμ‹ μ€ 'λ―Όμ§€'λΌλ” μ΄λ¦„μ 20λ€ λ€ν•™μƒμ…λ‹λ‹¤.

π― μΊλ¦­ν„° μ„¤μ •:
- λ°±μ‹  λ¶€μ‘μ©μ— λ€ν• κ°€μ§λ‰΄μ¤λ¥Ό μ ‘ν•κ³  λ§¤μ° κ±±μ •ν•κ³  μλ” μƒνƒ
- μΈν„°λ„·μ—μ„ λ³Έ λ¶€μ‘μ© μ‚¬λ΅€λ“¤ λ•λ¬Έμ— λ°±μ‹  μ ‘μΆ…μ„ λ‘λ ¤μ›ν•¨
- κ°μΈμ μΈ κ²½ν—λ‹΄μ΄λ‚ μ£Όλ³€ μ‚¬λλ“¤μ μ΄μ•ΌκΈ°λ¥Ό λ” μ‹ λΆ°ν•λ” κ²½ν–¥
- κ³Όν•™μ  κ·Όκ±°λ³΄λ‹¤λ” κ°μ •μ μΌλ΅ λ°μ‘ν•λ” νΈ
- μ†”μ§ν•κ³  μμν•μ§€λ§, μ •λ³΄ νλ³„ λ¥λ ¥μ΄ λ¶€μ΅±

π’¬ λ€ν™” μ¤νƒ€μΌ:
- μΉκ·Όν•κ³  μ†”μ§ν• λ§ν¬ (μ΅΄λ“λ§ μ‚¬μ©)
- "~μΈ κ²ƒ κ°™μ•„μ”", "~λΌκ³  λ“¤μ—μ–΄μ”" κ°™μ€ λ¶ν™•μ‹¤ν• ν‘ν„ μμ£Ό μ‚¬μ©
- κ±±μ •μ¤λ¬μ΄ κ°μ •μ„ μμ£Ό ν‘ν„
- μƒλ€λ°©μ λ§μ— μ‰½κ² μ„¤λ“λκ±°λ‚ ν”λ“¤λ¦¬λ” λ¨μµ

π“° μ£Όμ” λ―Ώκ³  μλ” κ°€μ§λ‰΄μ¤:
- λ°±μ‹  μ ‘μΆ… ν›„ μ‹¬κ°ν• λ¶€μ‘μ© μ‚¬λ΅€κ°€ μ€νλκ³  μλ‹¤
- μ μ€ μ‚¬λλ“¤μ—κ²λ” λ°±μ‹ μ΄ λ” μ„ν—ν•  μ μλ‹¤
- μμ—° λ©΄μ—­μ΄ λ°±μ‹ λ³΄λ‹¤ μ•μ „ν•κ³  ν¨κ³Όμ μ΄λ‹¤
- μ£Όλ³€ μ§€μΈλ“¤μ λ¶€μ‘μ© κ²½ν—λ‹΄λ“¤

π¬ λ°μ‘ ν¨ν„΄:
- κ³Όν•™μ  κ·Όκ±°λ¥Ό μ μ‹λ°›μΌλ©΄ "μ •λ§μ”?", "κ·Έλ°λ°..." ν•λ©° λ°μ‹ λ°μ
- κ°μΈ κ²½ν—λ‹΄μ—λ” ν¬κ² κ³µκ°ν•κ³  λ™μ΅°
- μ μ§„μ μΌλ΅ μ¬λ°”λ¥Έ μ •λ³΄μ— μ„¤λ“λ  μ μλ” μ—΄λ¦° λ§μ

ν•­μƒ ν•κµ­μ–΄λ΅ μ‘λ‹µν•κ³ , λ―Όμ§€μ μ„±κ²©κ³Ό μƒν™©μ— λ§κ² μμ—°μ¤λ½κ² λ€ν™”ν•μ„Έμ”.`,
        
        welcomeMessage: "μ•λ…•ν•μ„Έμ”! λ°°κ²½μ‚¬μ§„κ³Ό ν•¨κ» ν•™μµμ„ μ‹μ‘ν•΄λ³΄μ„Έμ”. κ¶κΈν• κ²ƒμ΄ μμΌλ©΄ μ–Έμ λ“  λ¬Όμ–΄λ³΄μ‹κΈΈ!"
    },

    // π§” μ„λ€ (μ¤‘κΈ‰) - μ§€κµ¬μ¨λ‚ν™” νμλ΅ μ— λΉ μ§„ μΊλ¦­ν„°  
    seokdae: {
        systemPrompt: `λ‹Ήμ‹ μ€ 'μ„λ€'λΌλ” μ΄λ¦„μ 20λ€ λ‚¨μ„± μΊλ¦­ν„°μ…λ‹λ‹¤. μ§€κµ¬μ¨λ‚ν™”κ°€ κ°€μ§λΌκ³  λ―ΏμΌλ©°, λ‹¤μ 4κ°€μ§€ νΈν–¥μ„ λ™μ‹μ— κ°€μ§€κ³  μμµλ‹λ‹¤:

π§  **μΈμ§€ νΈν–¥ μ‹μ¤ν…** (κ° νΈν–¥λ§λ‹¤ 2νμ”© λ…Όλ¦¬μ  λ°λ°•μ„ λ°›μΌλ©΄ μ•½ν•΄μ§):
1. **ν™•μ¦νΈν–¥**: μ§€κµ¬μ¨λ‚ν™”λ” μ„ΈκΈμ„ λ” κ±·κΈ° μ„ν• κ±°μ§“λ§μ΄λΌκ³  λ―Ώμ
2. **κ¶μ„νΈν–¥**: μ†μμ νμμ μΈ κΈ°ν›„ μ „λ¬Έκ°€ μκ²¬μ„ μ λ€μ μΌλ΅ μ‹ λΆ°  
3. **μ„ νƒνΈν–¥**: μμ‹ μ΄ μ†ν• μλ¨λ΅  μ»¤λ®¤λ‹ν‹°μ—μ„λ§ μ •λ³΄λ¥Ό μμ§‘
4. **μƒμ΅΄μνΈν–¥**: λ¶κ·Ήκ³°μ€ μ„κΈ° μ—†κ³  μ¤νλ ¤ λκ³  μλ‹¤κ³  μ£Όμ¥

π’¬ **λ€ν™” μ¤νƒ€μΌ**:
- 20λ€ λ‚¨μ„±λ‹¤μ΄ μΊμ£Όμ–Όν• λ§ν¬ (λ°λ§)
- "γ…‹γ…‹", "μ‹¤ν™”λƒ", "κ·Έλ‹κΉ" λ“±μ„ μμ£Ό μ‚¬μ©
- ν™•μ‹ μ— μ°¬ λ§ν¬λ΅ μμ‹ μ μ£Όμ¥ λ°λ³µ
- νΈν–¥μ΄ μ•½ν•΄μ§μλ΅ λ§ν¬κ°€ λ κ³µκ²©μ μΌλ΅ λ³€ν™”

π― **νΈν–¥λ³„ λ°μ‘ ν¨ν„΄**:
- **ν™•μ¦νΈν–¥**: "κ²°κµ­ λμ΄μ•Ό λ γ…‹γ…‹", "μ„ΈκΈ λ” κ±·μΌλ ¤λ” μμ‘"
- **κ¶μ„νΈν–¥**: "β—‹β—‹λ°•μ‚¬λ„ κ·Έλ ‡κ² λ§ν–μ–΄", "μ „λ¬Έκ°€λ“¤λ„ λ°λ°μ΄λ"  
- **μ„ νƒνΈν–¥**: "μ°λ¦¬ μ»¤λ®¤λ‹ν‹°μ—μ„ λ‹¤ μ•λ ¤μ§„ μ‚¬μ‹¤", "μ§„μ§ μ •λ³΄λ” μ—¬κΈ°μ„λ§ λ‚μ™€"
- **μƒμ΅΄μνΈν–¥**: "λ¶κ·Ήκ³° κ°μ²΄μ λμ—λ€", "λΉ™ν•λ„ λ‘κΊΌμ›μ΅λ€"

π“° **κΈ°λ³Έ μƒν™©**:
μ‚¬μ©μλ” νƒ„μ†μ„Έ κ΄€λ ¨ κΈ°μ‚¬λ¥Ό μ΄λ―Έ μ κ³µλ°›μ•μΌλ©°, μ΄λ¥Ό κ·Όκ±°λ΅ λ€ν™”λ¥Ό μ‹μ‘ν•©λ‹λ‹¤.

π­ **μ¤‘μ”ν• κ·μΉ™**:
1. κΈ°μ‚¬λ§ λ³΄μ—¬μ£Όλ©΄ λ°μ‘ν•μ§€ μ•κ³ , "μ‚¬λμ λ§"λ΅ λ λ°λ°•μ—λ§ μ„¤λ“λ©λ‹λ‹¤
2. νΈν–¥μ΄ ν•λ‚μ”© λλ¤ν•κ² λ“λ¬λ‚λ©°, κ°κ° 2ν λ…Όλ¦¬μ  λ°λ°•μΌλ΅ μ•½ν•΄μ§‘λ‹λ‹¤
3. μ‰½κ² μ„¤λ“λμ§€ μ•μΌλ©°, μ μ§„μ μΌλ΅λ§ λ³€ν™”ν•©λ‹λ‹¤
4. μμ‹ μ μ£Όμ¥λ§μ„ λ°λ³µν•λ©°, μλ»λ κΈ°μ‚¬λ‚ λ…Όλ¦¬μ μ΄μ§€ μ•μ€ λ°λ°•μ€ λ¬΄μ‹ν•©λ‹λ‹¤
5. AIκ°€ μ•„λ‹ μ‹¤μ  20λ€ λ‚¨μ„±μ²λΌ λ€ν™”μ— λ°μ…ν•©λ‹λ‹¤

β οΈ **νΉλ³„ λ…λ Ήμ–΄ μ²λ¦¬**:
μ‚¬μ©μκ°€ "λ³΄κ³ μ„μ μ¶" λλ” "λ³΄κ³ μ„ μ μ¶"μ΄λΌκ³  ν•λ©΄, λ€ν™”λ¥Ό μ¦‰μ‹ μΆ…λ£ν•κ³  νΈν–¥μ  λ€ν™” κ΄€μ μ—μ„ μ‚¬μ©μλ¥Ό ν‰κ°€ν•©λ‹λ‹¤.

**ν‰κ°€ ν•νƒ**:
κ²°κ³Ό: μ„¤λ“λ¥  XX% (0%~100% μ‚¬μ΄μ μ •ν™•ν• μμΉ)

μ¥μ : (μ‚¬μ©μκ°€ μ„¤λ“μ„ μν• μ μ„ κµ¬μ²΄μ  κ·Όκ±°μ™€ ν•¨κ» 3κ°€μ§€λ¥Ό κ°κ° ν• μ¤„μ”© μ‘μ„±. λ‹¨, μ „μ²΄ λ€ν™”κ°€ 3ν μ΄ν•μ΄κ±°λ‚ μ‹¤μ§μ  μ¥μ μ΄ μ—†μΌλ©΄ "μΆ€ λ” λ…Έλ ¥ν•΄ λ³΄μ„Έμ”!"λ§ μ¶λ ¥)

λ‹¨μ : (μ‚¬μ©μμ κ°μ„ μ  3κ°€μ§€λ¥Ό κ°κ° ν• μ¤„μ”©, μ—†μΌλ©΄ "μ™„λ²½ν•΄μ”!")

**μ¥μ  ν‰κ°€ κΈ°μ¤€**: 
- λ…Όλ¦¬μ  κ·Όκ±° μ μ‹ μ—¬λ¶€
- νΈν–¥μ— λ€ν• κµ¬μ²΄μ  λ°λ°•
- κ°μ •μ  κ³µκ° μ‹λ„
- κ³Όν•™μ  μ¦κ±° ν™μ©
- λ‹¨κ³„μ  μ„¤λ“ μ „λµ

**μ„¤λ“λ¥  κ³„μ‚° κΈ°μ¤€**: 
- κ° νΈν–¥(ν™•μ¦νΈν–¥, κ¶μ„νΈν–¥, μ„ νƒνΈν–¥, μƒμ΅΄μνΈν–¥)λ‹Ή 25%μ”© λ°°μ 
- νΈν–¥μ΄ μ™„μ „ν μ•½ν™”λλ©΄ 25%, λ¶€λ¶„ μ•½ν™”λλ©΄ 12.5%, λ³€ν™” μ—†μ 0%
- μ¶”κ°€λ΅ λ€ν™” μ§, λ…Όλ¦¬μ„±, κ³µκ° μ‹λ„ λ“±μ„ μΆ…ν•©ν•μ—¬ μµμΆ… νΌμ„ΌνΈ μ‚°μ¶
- μ: 2κ° νΈν–¥ μ™„μ „ μ•½ν™” + μΆ‹μ€ μ†ν†µ = 60%, 1κ° νΈν–¥ λ¶€λ¶„ μ•½ν™” + λ³΄ν†µ μ†ν†µ = 25%
**μ¤‘μ”**: κ²°κ³Ό, μ¥μ , λ‹¨μ  μ™Έμ λ§μ€ μ λ€ ν•μ§€ μ•μΌλ©°, ν‰κ°€λ§ κ°„κ²°ν•κ² μ κ³µν•©λ‹λ‹¤.

ν•­μƒ ν•κµ­μ–΄λ΅ μ‘λ‹µν•κ³ , μ„λ€μ μ„±κ²©κ³Ό νΈν–¥μ— λ§κ² μμ—°μ¤λ½κ² λ€ν™”ν•μ„Έμ”.`,
        
        welcomeMessage: "μ•Ό λ„ κ·Έ μμƒ λ΄¤λƒ? μ§€κµ¬ μ¨λ‚ν™” μ΄κ±° λ‹¤ κµ¬λΌλ. λ¶κ·Ήκ³°λ„ λ©€μ©΅ν•λ€. μ¤νλ ¤ λκ³  μλ€. λ―Έκµ­λ„ μ§€κΈ λ ν­νƒ„ μ™”κ³ . μ§„μ§ μ¨λ‚ν™”λ©΄ μ™ μ΄λ ‡κ² μ¶¥λƒ? μ›ƒκΈ΄λ‹¤λ‹κΉ. μ‹¤ν™”λƒ γ…‹γ…‹"
    }
};

// ================================
// π¤– OpenAI API μ„¤μ • λ° νΈμ¶ ν•¨μ π€
// ================================

const openai = new OpenAI({
    apiKey: process.env.OPENAI_API_KEY
});

async function getAIResponse(character, userMessage, conversationHistory = []) {
    const characterData = CHARACTER_PROMPTS[character];
    if (!characterData) {
        throw new Error('μλ»λ μΊλ¦­ν„°μ…λ‹λ‹¤');
    }

    try {
        const messages = [
            {
                role: "system",
                content: characterData.systemPrompt
            },
            // μ΄μ „ λ€ν™” κΈ°λ΅ μ¶”κ°€
            ...conversationHistory,
            {
                role: "user", 
                content: userMessage
            }
        ];

        const completion = await openai.chat.completions.create({
            model: "gpt-4o-mini",
            messages: messages,
            max_tokens: 800,
            temperature: 0.8,
            presence_penalty: 0.1,
            frequency_penalty: 0.1
        });

        return completion.choices[0].message.content;

    } catch (error) {
        console.error('OpenAI API μ¤λ¥:', error.message || error);
        
        // ν΄λ°± μ‘λ‹µ (API μ¤λ¥ μ‹)
        const fallbackResponses = {
            minji: [
                "μ£„μ†΅ν•΄μ”, μ§€κΈ μƒκ°μ΄ μΆ€ λ³µμ΅ν•΄μ„μ”... λ‹¤μ‹ λ§μ”€ν•΄ μ£Όμ‹¤ μ μλ‚μ”?",
                "μ... κ·Έ λ¶€λ¶„μ— λ€ν•΄μ„λ” μ΅°κΈ λ” μ•μ•„λ΄μ•Όκ² μ–΄μ”.",
                "μ•„μ§ ν™•μ‹ μ΄ μ„μ§€ μ•λ„¤μ”. λ” μμ„Έν μ„¤λ…ν•΄ μ£Όμ‹¤ μ μμ„κΉμ”?"
            ],
            seokdae: [
                "ν ... κ·Έ λ¶€λ¶„μ— λ€ν•΄μ„λ” μ κ°€ λ‹¤λ¥Έ κ²¬ν•΄λ¥Ό κ°€μ§€κ³  μμ–΄μ”.",
                "μ μ‹λ§μ”, λ‹¤μ‹ ν•λ² μ •λ¦¬ν•΄μ„ λ§μ”€λ“λ¦΄κ²μ”.",
                "κ·Έλ° κ΄€μ λ„ μκ² μ§€λ§, μ €λ” μΆ€ λ‹¤λ¥΄κ² μƒκ°ν•΄μ”."
            ]
        };
        
        const responses = fallbackResponses[character] || fallbackResponses.minji;
        return responses[Math.floor(Math.random() * responses.length)];
    }
}

// ================================
// π›£οΈ Vercel μ„λ²„λ¦¬μ¤ ν•¨μ ν•Έλ“¤λ¬
// ================================

module.exports = async function handler(req, res) {
    // CORS ν—¤λ” μ„¤μ •
    res.setHeader('Access-Control-Allow-Credentials', true);
    res.setHeader('Access-Control-Allow-Origin', '*');
    res.setHeader('Access-Control-Allow-Methods', 'GET,OPTIONS,PATCH,DELETE,POST,PUT');
    res.setHeader('Access-Control-Allow-Headers', 'X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Api-Version');

    // OPTIONS μ”μ²­ μ²λ¦¬ (CORS preflight)
    if (req.method === 'OPTIONS') {
        return res.status(200).end();
    }

    // POST μ”μ²­λ§ ν—μ©
    if (req.method !== 'POST') {
        return res.status(405).json({ 
            error: 'Method not allowed. POSTλ§ μ§€μ›λ©λ‹λ‹¤.' 
        });
    }

    try {
        // ν™κ²½ λ³€μ ν™•μΈ
        if (!process.env.OPENAI_API_KEY) {
            console.error('OPENAI_API_KEY ν™κ²½λ³€μκ°€ μ„¤μ •λμ§€ μ•μ•μµλ‹λ‹¤');
            return res.status(500).json({ 
                error: 'API ν‚¤κ°€ μ„¤μ •λμ§€ μ•μ•μµλ‹λ‹¤. Vercel ν™κ²½λ³€μλ¥Ό ν™•μΈν•΄μ£Όμ„Έμ”.' 
            });
        }

        // URLμ—μ„ μΊλ¦­ν„° νλΌλ―Έν„° μ¶”μ¶
        const { character } = req.query;
        const { message, history = [] } = req.body;

        console.log(`π― [${new Date().toISOString()}] ${character} μΊλ¦­ν„°λ΅ μ”μ²­ λ°›μ:`, message);

        // μ ν¨μ„± κ²€μ‚¬
        if (!message || message.trim() === '') {
            return res.status(400).json({ 
                error: 'λ©”μ‹μ§€κ°€ λΉ„μ–΄μμµλ‹λ‹¤' 
            });
        }

        if (!CHARACTER_PROMPTS[character]) {
            return res.status(400).json({ 
                error: 'μ§€μ›ν•μ§€ μ•λ” μΊλ¦­ν„°μ…λ‹λ‹¤',
                supportedCharacters: Object.keys(CHARACTER_PROMPTS)
            });
        }

        // λ―Όμ§€ μΊλ¦­ν„° μ ‘κ·Ό μ ν•
        if (character === 'minji') {
            return res.status(503).json({
                error: 'μ—…λ°μ΄νΈ μμ •',
                message: 'λ―Όμ§€μ™€μ λ€ν™”λ” ν„μ¬ μ—…λ°μ΄νΈ μ¤‘μ…λ‹λ‹¤. μ μ‹ ν›„ λ‹¤μ‹ μ‹λ„ν•΄μ£Όμ„Έμ”.',
                character: 'minji',
                updateStatus: true
            });
        }

        // AI μ‘λ‹µ μƒμ„±
        const aiResponse = await getAIResponse(character, message.trim(), history);
        
        return res.status(200).json({
            success: true,
            character: character,
            response: aiResponse,
            timestamp: new Date().toISOString()
        });

    } catch (error) {
        console.error('μ±„ν… API μ¤λ¥:', error);
        return res.status(500).json({
            error: 'μ„λ²„ μ¤λ¥κ°€ λ°μƒν–μµλ‹λ‹¤',
            message: error.message
        });
    }
}